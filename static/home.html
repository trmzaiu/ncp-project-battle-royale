<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="lobby.css" id="lobby-style">
    <link rel="stylesheet" href="game.css" id="game-style" disabled>
    <title>Royaka</title>
</head>

<body>
    <div class="home-container" id="lobby">
        <div class="header">
            <h1 class="title">üè∞ ROYAKA</h1>
            <p class="subtitle">
                Begin your adventure in the mystical world of Eldoria
            </p>
        </div>

        <div class="container">
            <div class="card player-card">
                <div class="avatar">
                    <span id="userInitial"></span>
                </div>
                <h2 class="user-name" id="username">User</h2>

                <div class="stats-container">
                    <div class="stat-item">
                        <span class="stat-label">Level</span>
                        <span class="stat-value" id="level">1</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Experience</span>
                        <span class="stat-value" id="exp">0/100</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" id="expProgress"></div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Games Played</span>
                        <span class="stat-value" id="gamesPlayed">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Wins</span>
                        <span class="stat-value" id="wins">0</span>
                    </div>
                </div>
            </div>

            <div class="card game-options">
                <h3 class="section-title">Game Modes</h3>

                <div class="game-modes">
                    <div class="mode-card selected" data-mode="simple">
                        <div class="mode-icon">üè∞</div>
                        <div class="mode-title">Simple</div>
                        <div class="mode-desc">
                            Turn-based tower battle with basic rules
                        </div>
                    </div>
                    <div class="mode-card" data-mode="enhanced">
                        <div class="mode-icon">‚öîÔ∏è</div>
                        <div class="mode-title">Enhanced</div>
                        <div class="mode-desc">
                            Real-time battle with skills, EXP, and leveling
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="startGameBtn" onclick="findMatch()">
                    <span>Start Game</span>
                </button>

                <button class="btn btn-secondary" id="leaderboardBtn">
                    View Leaderboard
                </button>

                <button class="btn btn-accent" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="log-container">
            <div class="log-entry">
                <span id="timestamp" class="timestamp"></span>
                <span class="type">SYSTEM</span>
                <span class="message">Welcome to Royaka!</span>
            </div>
            <div id="log"></div>
        </div>

        <div class="notification" id="notification">
            Connecting to game server...
        </div>
    </div>

    <div class="game-container" id="gameView" style="display: none;">
        <div class="stats-bar">
            <div class="opponent-stats">
                <div class="opponent-avatar" id="opponent-avatar">O</div>
                <div class="stat-column">
                    <div class="stat">
                        <div class="stat-label">Opponent:</div>
                        <div class="stat-value name" id="opponent-name">Opponent</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Level:</div>
                        <div class="stat-value" id="opponent-level">5</div>
                    </div>
                </div>
            </div>

            <div class="stat turn-display">
                <div class="stat-label">Your Turn</div>
            </div>

            <div class="player-stats">
                <div class="user-avatar" id="user-avatar">P</div>
                <div class="stat-column">
                    <div class="stat">
                        <div class="stat-label">You:</div>
                        <div class="stat-value name" id="user-name">User</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Level:</div>
                        <div class="stat-value" id="user-level">5</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="battle-container">
            <div class="battlefield">
                <!-- Opponent Side -->
                <div class="player-side opponent" id="opponent-side">
                    <!-- King Tower -->
                    <div class="tower king" id="opponent-king" data-target="king">
                        <div class="tower-icon">üëë</div>
                        <div class="tower-hp">
                            <div class="hp-bar">
                                <div class="hp-fill" id="opponent-king-hp-fill" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="shield-indicator" id="opponent-king-shield">0</div>
                        <div class="tower-status" id="opponent-king-status"></div>
                    </div>
                    <div class="tower-container">
                        <!-- Guard Towers -->
                        <div class="towers">
                            <div class="tower" id="opponent-guard1" data-target="guard1">
                                <div class="tower-icon">üõ°Ô∏è</div>
                                <div class="tower-hp">
                                    <div class="hp-bar">
                                        <div class="hp-fill" id="opponent-guard1-hp-fill" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="shield-indicator" id="opponent-guard1-shield">
                                    0
                                </div>
                                <div class="tower-status" id="opponent-guard1-status"></div>
                            </div>

                            <div class="tower" id="opponent-guard2" data-target="guard2">
                                <div class="tower-icon">üõ°Ô∏è</div>
                                <div class="tower-hp">
                                    <div class="hp-bar">
                                        <div class="hp-fill" id="opponent-guard2-hp-fill" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="shield-indicator" id="opponent-guard2-shield">
                                    0
                                </div>
                                <div class="tower-status" id="opponent-guard2-status"></div>
                            </div>
                        </div>
                    </div>
                    <div class="animation-container" id="opponent-animations"></div>
                </div>

                <!-- Player Side -->
                <div class="player-side" id="player-side">
                    <div class="tower-container">
                        <!-- Guard Towers -->
                        <div class="towers">
                            <div class="tower" id="player-guard1">
                                <div class="tower-icon">üõ°Ô∏è</div>
                                <div class="tower-hp">
                                    <div class="hp-bar">
                                        <div class="hp-fill" id="player-guard1-hp-fill" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="shield-indicator" id="player-guard1-shield">
                                    0
                                </div>
                                <div class="tower-status" id="player-guard1-status"></div>
                            </div>

                            <div class="tower" id="player-guard2">
                                <div class="tower-icon">üõ°Ô∏è</div>
                                <div class="tower-hp">
                                    <div class="hp-bar">
                                        <div class="hp-fill" id="player-guard2-hp-fill" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="shield-indicator" id="player-guard1-shield">
                                    0
                                </div>
                                <div class="tower-status" id="player-guard1-status"></div>
                            </div>
                        </div>

                        <div class="animation-container" id="player-animations"></div>
                    </div>
                    <!-- King Tower -->
                    <div class="tower king" id="player-king">
                        <div class="tower-hp">
                            <div class="hp-bar">
                                <div class="hp-fill" id="player-king-hp-fill" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="tower-icon">üëë</div>
                        <div class="shield-indicator" id="player-king-shield">0</div>
                        <div class="tower-status" id="player-king-status"></div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <div class="troops-container">
                    <div class="section-header">
                        <div id="mana-container" class="mana-bar-container"></div>
                    </div>

                    <div class="troop-selection">
                        <div class="troop" id="troop1" data-cost="">
                            <div class="troop-icon"></div>
                            <div class="troop-name"></div>
                            <div class="troop-mana-cost"></div>
                            <div class="ability-description"></div>
                        </div>

                        <div class="troop" id="troop2" data-cost="">
                            <div class="troop-icon"></div>
                            <div class="troop-name"></div>
                            <div class="troop-mana-cost"></div>
                            <div class="ability-description"></div>
                        </div>

                        <div class="troop" id="troop3" data-cost="">
                            <div class="troop-icon"></div>
                            <div class="troop-name"></div>
                            <div class="troop-mana-cost"></div>
                            <div class="ability-description"></div>
                        </div>

                        <div class="troop" id="troop4" data-cost="">
                            <div class="troop-icon"></div>
                            <div class="troop-name"></div>
                            <div class="troop-mana-cost"></div>
                            <div class="ability-description"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="log-container" id="log-container">
            <div class="log-entry">
                <span id="timestamp" class="timestamp"></span>
                <span class="type"></span>
                <span class="message">Welcome to Royaka!</span>
            </div>
            <div id="log"></div>
        </div>

        <div class="notification" id="notification">
            <span id="notification-text"></span>
        </div>

        <div class="game-over-modal" id="game-over-modal">
            <div class="modal-content">
                <h2 class="modal-title" id="result-title">Victory!</h2>
                <div class="modal-body">
                    <p id="result-message">You have defeated your opponent!</p>
                    <div class="exp-gain" id="exp-gain">+100 XP</div>

                    <div class="stats-summary">
                        <div class="stat-row">
                            <span class="stat-label">Turns Played:</span>
                            <span class="stat-value" id="stats-turns">12</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Damage Dealt:</span>
                            <span class="stat-value" id="stats-damage">3500</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Mana Spent:</span>
                            <span class="stat-value" id="stats-mana">45</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Critical Hits:</span>
                            <span class="stat-value" id="stats-crits">4</span>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" id="play-again-btn">
                        Play Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Game Lobby Script ---
        let selectedMode = "simple";
        let isJoiningGame = false;
        let user, opponent, yourTurn;
        let gameState;
        let isGameInitialized = false;
        let socket = null;

        // Mode Selection
        function setupModeSelection() {
            document.querySelectorAll(".mode-card").forEach((card) => {
                card.addEventListener("click", () => {
                    document
                        .querySelectorAll(".mode-card")
                        .forEach((c) => c.classList.remove("selected"));
                    card.classList.add("selected");
                    selectedMode = card.dataset.mode;
                });
            });
        }

        // Notifications
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.classList.add("show");
            setTimeout(() => notification.classList.remove("show"), duration);
        }

        // Logging
        function addLogEntry(type, message) {
            const logContainer = document.getElementById("log");
            const entry = document.createElement("div");
            entry.className = "log-entry";

            const now = new Date();
            const timestamp = now.toLocaleTimeString([], { hour12: true });

            entry.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <span class="type">${type}</span>
                <span class="message">${message}</span>
            `;

            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Start Game Handler
        function findMatch() {
            if (isJoiningGame) {
                showNotification("Already searching for a match...");
                return;
            }

            const btn = document.getElementById("startGameBtn");
            const originalText = btn.innerHTML;
            isJoiningGame = true;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Finding match...';

            if (socket && socket.readyState === WebSocket.OPEN && user) {
                showToast("Joining match queue...");

                const payload = {
                    type: "find_match",
                    data: {
                        user: user,
                        mode: selectedMode,
                    },
                };

                socket.send(JSON.stringify(payload));
                console.log("Sending find_match request:", payload);
                addLogEntry("SYSTEM", `Searching for ${selectedMode} match...`);
                showNotification(`Looking for ${selectedMode} match...`);
            } else {
                addLogEntry("ERROR", "Not connected to server or user data missing");
                showNotification("Connection error. Reconnecting...");
                connectWebSocket();

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    isJoiningGame = false;
                }, 2000);
            }
        }

        function showToast(message) {
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.innerText = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add("show"), 100);
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function connectWebSocket() {
            socket = new WebSocket("ws://localhost:8080/ws");

            socket.onopen = () => {
                addLogEntry("SYSTEM", "Connected to game server");
                showNotification("Connected to game server");
                document.getElementById("startGameBtn").disabled = false;

                const sessionId = localStorage.getItem("session_id");
                if (sessionId) {
                    socket.send(
                        JSON.stringify({
                            type: "get_user",
                            data: { session_id: sessionId },
                        })
                    );
                    addLogEntry("SYSTEM", "Fetching user data...");
                } else {
                    addLogEntry("ERROR", "Session ID not found");
                    showNotification("Session ID not found. Please log in again.");
                }
            };

            socket.onmessage = handleSocketMessage;

            socket.onclose = () => {
                addLogEntry("SYSTEM", "Disconnected from server");
                showNotification("Disconnected from server. Reconnecting...");
                isJoiningGame = false;
                setTimeout(connectWebSocket, 1000);
            };

            socket.onerror = () => {
                addLogEntry("ERROR", "WebSocket error");
                showNotification("WebSocket error");
                isJoiningGame = false;
            };
        }

        function handleSocketMessage(event) {
            const msg = JSON.parse(event.data);
            console.log("Received message:", msg);

            if (msg.type === "user_response") {
                handleUserResponse(msg);
            } else if (msg.type === "match_found") {
                handleMatchFound(msg);
            } else if (msg.type === "game_response") {
                handleGameResponse(msg);
            } else if (msg.type === "attack_response") {
                handleAttackResponse(msg);
            }

            if (msg.type === "error" || (msg.type === "find_match_response" && !msg.success)) {
                const btn = document.getElementById("startGameBtn");
                btn.disabled = false;
                btn.innerHTML = "<span>Start Game</span>";
                isJoiningGame = false;
            }
        }

        function handleUserResponse(msg) {
            if (msg.success) {
                user = msg.data;
                document.getElementById("username").innerText = user.username;
                document.getElementById("userInitial").innerText = user.username.charAt(0).toUpperCase();
                document.getElementById("level").innerText = user.level || "N/A";
                document.getElementById("exp").innerText = `${user.exp || 0}/${user.maxExp || 0
                    }`;

                if (user.exp && user.maxExp) {
                    document.getElementById("expProgress").style.width = `${(user.exp / user.maxExp) * 100}%`;
                }

                document.getElementById("gamesPlayed").innerText = user.gamesPlayed || 0;
                document.getElementById("wins").innerText = user.gamesWon || 0;
                addLogEntry("SYSTEM", "Fetched user data successfully!");
                return;
            } else {
                addLogEntry("ERROR", msg.message || "Failed to fetch user data");
                showNotification(msg.message || "Login failed. Please try again.");
            }
        }

        function handleMatchFound(msg) {
            if (msg.success) {
                localStorage.setItem("room_id", msg.data.room_id);
                localStorage.setItem("username", user.username);

                addLogEntry("SYSTEM", "Match found! Starting game...");
                showNotification("Match found! Starting game...");
                goToGame();
            } else {
                addLogEntry("ERROR", msg.message || "Failed to find a match");
                showNotification(
                    msg.message || "Failed to find a match. Please try again."
                );
            }
        }

        function handleGameResponse(msg) {
            if (msg.success) {
                updateUserAndOpponentInfo(msg.data);
                yourTurn = msg.data.your_turn;
                console.log("Your turn:", yourTurn);

                if (!isGameInitialized) {
                    initializeGame(msg.data.user.troops);
                }
            } else {
                console.error("Failed to get game info:", msg.error);
            }
        }

        function updateUserAndOpponentInfo(data) {
            user = data.user;
            document.getElementById("user-name").innerText = user.user.username;
            document.getElementById("user-avatar").innerText = user.user.username.charAt(0).toUpperCase();
            document.getElementById("user-level").innerText = user.user.level;

            opponent = data.opponent;
            document.getElementById("opponent-name").innerText = opponent.user.username;
            document.getElementById("opponent-avatar").innerText = opponent.user.username.charAt(0).toUpperCase();
            document.getElementById("opponent-level").innerText = opponent.user.level;
        }

        function initializeGame(troops) {
            initGameState();
            loadTroops(troops);
            initGame();
            addLogEntry("SYSTEM", "Game started.");
            if (yourTurn) {
                addLogEntry("SYSTEM", "Your turn.");
            } else {
                addLogEntry("SYSTEM", "Waiting for opponent's turn...");
            }
            isGameInitialized = true;
        }

        function handleAttackResponse(msg) {
            if (msg.success) {
                console.log("Attack success:", msg);
            } else {
                console.error("Attack failed:", msg.error);
            }
        }

        function initGameState() {
            gameState = {
                turn: yourTurn,
                playerMana: user.mana,
                maxMana: 10,
                playerHealth: {
                    king: user.towers.king.max_hp,
                    guard1: user.towers.guard1.max_hp,
                    guard2: user.towers.guard2.max_hp,
                },
                opponentHealth: {
                    king: opponent.towers.king.max_hp,
                    guard1: opponent.towers.guard1.max_hp,
                    guard2: opponent.towers.guard2.max_hp,
                },
                troops: {},
                selectedTroop: null,
                selectedTarget: null,
                playerTurn: true,
                gameOver: false,
            };
        }

        function updateManaDisplay() {
            const currentMana = gameState.playerMana;
            const maxMana = gameState.maxMana;

            const manaContainer = document.getElementById("mana-container");
            manaContainer.innerHTML = "";

            for (let i = 0; i < maxMana; i++) {
                const segment = document.createElement("div");
                segment.className = "mana-segment";
                if (i < currentMana) segment.classList.add("filled");
                manaContainer.appendChild(segment);
            }

            updateTroopAvailability();
        }

        function updateTroopAvailability() {
            document.querySelectorAll(".troop").forEach(troopDiv => {
                const cost = parseInt(troopDiv.dataset.cost, 10);
                if (gameState.playerMana < cost) {
                    troopDiv.classList.add("disabled");
                } else {
                    troopDiv.classList.remove("disabled");
                }
            });
        }

        function loadTroops(troopsArray) {
            const container = document.querySelector(".troop-selection");
            container.innerHTML = "";

            if (!gameState.troop) gameState.troop = {};

            troopsArray.forEach((troop, index) => {
                gameState.troops[troop.name] = troop;

                const troopDiv = document.createElement("div");
                troopDiv.className = "troop";
                troopDiv.id = `troop${index + 1}`;
                troopDiv.dataset.cost = troop.mana;
                troopDiv.dataset.troopName = troop.name;

                troopDiv.innerHTML = `
            <div class="troop-icon">${troop.icon}</div>
            <div class="troop-name">${troop.name}</div>
            <div class="troop-mana-cost">${troop.mana}</div>
            <div class="ability-description">${troop.description}</div>
        `;

                if (gameState.playerMana < troop.mana) {
                    troopDiv.classList.add("disabled");
                }

                troopDiv.addEventListener("click", () => selectTroop(troopDiv));
                container.appendChild(troopDiv);
            });
        }

        function selectTroop(troopDiv) {
            if (!yourTurn) return showNotification("Not your turn.");
            if (troopDiv.classList.contains("disabled")) return showNotification("Not enough mana to use this troop.");

            document.querySelectorAll(".troop.selected").forEach(div => div.classList.remove("selected"));
            troopDiv.classList.add("selected");

            const troopName = troopDiv.dataset.troopName;
            const troopData = gameState.troops[troopName];

            if (gameState.playerMana < troopData.mana) {
                showNotification("Not enough mana!");
                return;
            }

            gameState.selectedTroop = troopData;
        }

        function selectTarget(towerDiv) {
            if (!yourTurn || !gameState.selectedTroop || !gameState.playerTurn) {
                return showNotification("Invalid action.");
            }

            if (gameState.playerMana < gameState.selectedTroop.mana)
                return showNotification("Not enough mana.");

            const target = towerDiv.dataset.target;
            const troop = gameState.selectedTroop;

            gameState.playerMana -= troop.mana;
            updateManaDisplay();

            const payload = {
                type: "attack",
                data: {
                    troop: troop.name,
                    target: target,
                    room_id: localStorage.getItem("room_id"),
                    username: localStorage.getItem("username"),
                },
            };

            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(payload));
                console.log("Sending attack request:", payload);
            } else {
                console.error("WebSocket is not open. State: " + socket.readyState);
            }

            yourTurn = false;
            gameState.playerTurn = false;

            addLogEntry("ACTION", `${troop.name} deployed to attack ${target}.`);
            addLogEntry("SYSTEM", "Waiting for opponent's turn...");

            document.querySelectorAll(".troop").forEach(div => div.classList.remove("selected"));
            gameState.selectedTroop = null;
        }

        function initGame() {
            updateManaDisplay();

            setInterval(() => {
                if (gameState.playerMana < gameState.maxMana) {
                    gameState.playerMana++;
                    updateManaDisplay();
                }
            }, 3000);

            document.querySelectorAll(".tower[data-target]").forEach(tower => {
                tower.addEventListener("click", () => selectTarget(tower));
            });
        }

        function goToGame() {
            const room_id = localStorage.getItem("room_id");
            const username = localStorage.getItem("username");
            console.log("Room ID:", room_id);

            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "get_game",
                    data: { room_id, username },
                }));
            }

            document.getElementById("lobby").style.display = "none";
            document.getElementById("gameView").style.display = "block";
            document.getElementById("lobby-style").disabled = true;
            document.getElementById("game-style").disabled = false;

            initGame();
        }

        // Setup button listeners
        function setupUI() {
            document
                .getElementById("startGameBtn")
                .addEventListener("click", findMatch);
            document
                .getElementById("leaderboardBtn")
                .addEventListener("click", () =>
                    showNotification("Leaderboard coming soon!")
                );
            document
                .getElementById("logoutBtn")
                .addEventListener("click", () =>
                    showNotification("Logout coming soon!")
                );
            document.getElementById("timestamp").textContent = new Date().toLocaleTimeString();
        }

        // Init
        setupModeSelection();
        setupUI();
        connectWebSocket();
    </script>
</body>

</html>