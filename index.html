<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Battle Royale Client with Map</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #log { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px; margin-top: 10px; background: #f9f9f9; }
    button { margin: 5px; }
    #map { display: grid; grid-template-columns: repeat(10, 30px); grid-gap: 2px; margin-top: 10px; }
    .cell {
      width: 30px;
      height: 30px;
      background-color: #eee;
      text-align: center;
      line-height: 30px;
      font-size: 12px;
      border: 1px solid #ccc;
    }
    .you { background-color: #4caf50; color: white; } /* green */
    .enemy { background-color: #f44336; color: white; } /* red */
  </style>
</head>
<body>
  <h2>ü™ñ Battle Royale Client</h2>
  <label>Player ID: <input id="playerId" value="player1" /></label>
  <button onclick="connect()">Connect</button>
  
  <div id="controls" style="display:none;">
    <p>Controls:</p>
    <button onclick="sendCmd('move up')">‚¨ÜÔ∏è Up</button><br/>
    <button onclick="sendCmd('move left')">‚¨ÖÔ∏è Left</button>
    <button onclick="sendCmd('move down')">‚¨áÔ∏è Down</button>
    <button onclick="sendCmd('move right')">‚û°Ô∏è Right</button><br/>
    <button onclick="sendCmd('status')">üìä Status</button>
  </div>

  <div id="map"></div>
  <div id="log"></div>

  <script>
    let ws;
    let currentPlayerId = "";
    let playerPositions = {}; // { id: {x, y} }

    function connect() {
      currentPlayerId = document.getElementById("playerId").value;
      ws = new WebSocket(`ws://localhost:8080/ws?id=${currentPlayerId}`);

      ws.onopen = () => {
        log("‚úÖ Connected to server");
        document.getElementById("controls").style.display = "block";
        sendCmd("status"); // y√™u c·∫ßu v·ªã tr√≠ sau khi k·∫øt n·ªëi
      };

      ws.onmessage = (event) => {
        log("üì© " + event.data);
        try {
          const data = JSON.parse(event.data);
          if (Array.isArray(data.players)) {
            // format: [{id, x, y}]
            playerPositions = {};
            data.players.forEach(p => {
              playerPositions[p.id] = { x: p.x, y: p.y };
            });
            renderMap();
          }
        } catch {
          // kh√¥ng ph·∫£i JSON, hi·ªÉn th·ªã tin nh·∫Øn b√¨nh th∆∞·ªùng
        }
      };

      ws.onclose = () => {
        log("‚ùå Disconnected from server");
      };
    }

    function sendCmd(cmd) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        log("‚û°Ô∏è Sending: " + cmd);
        ws.send(cmd);
        if (cmd.startsWith("move")) {
          setTimeout(() => sendCmd("status"), 200); // c·∫≠p nh·∫≠t l·∫°i b·∫£n ƒë·ªì sau di chuy·ªÉn
        }
      } else {
        log("‚ö†Ô∏è Not connected");
      }
    }

    function log(msg) {
      const logBox = document.getElementById("log");
      logBox.innerHTML += msg + "<br/>";
      logBox.scrollTop = logBox.scrollHeight;
    }

    function renderMap() {
      const map = document.getElementById("map");
      map.innerHTML = "";
      for (let y = 0; y < 10; y++) {
        for (let x = 0; x < 10; x++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          for (let id in playerPositions) {
            const pos = playerPositions[id];
            if (pos.x === x && pos.y === y) {
              cell.textContent = id === currentPlayerId ? "You" : "P";
              cell.classList.add(id === currentPlayerId ? "you" : "enemy");
            }
          }
          map.appendChild(cell);
        }
      }
    }
  </script>
</body>
</html>
